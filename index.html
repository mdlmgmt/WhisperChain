<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ChirpChain: Secret Note</title>
    <style>
        :root { 
            --bg: #050505; --card: #151515; 
            --neon-blue: #00f3ff; --neon-pink: #ff00ff; --neon-green: #00ff66;
            --text: #eee; --err: #ff3333;
        }
        body { 
            background: var(--bg); color: var(--text); 
            font-family: 'Verdana', sans-serif; 
            margin: 0; padding: 0; 
            overflow: hidden; height: 100vh; display: flex; flex-direction: column;
        }

        /* HEADER */
        header {
            padding: 15px;
            background: rgba(20,20,20,0.95);
            border-bottom: 2px solid var(--neon-pink);
            display: flex; justify-content: space-between; align-items: center;
            z-index: 100;
        }
        .brand { font-family: 'Courier New', monospace; font-weight: 900; font-size: 1.2rem; letter-spacing: -1px; }
        .brand span { color: var(--neon-blue); }
        .panic-btn { font-size: 1.5rem; cursor: pointer; transition: 0.2s; }
        .panic-btn:hover { transform: scale(1.1); }

        /* FEED */
        #feed {
            flex: 1; overflow-y: auto; padding: 15px;
            display: flex; flex-direction: column; gap: 10px;
            scroll-behavior: smooth;
            padding-bottom: 80px; /* Space for composer */
        }
        
        .bubble {
            background: var(--card); padding: 10px 14px; border-radius: 12px;
            border-left: 3px solid var(--neon-blue);
            animation: slideUp 0.3s ease; max-width: 85%;
        }
        .bubble.mine { align-self: flex-end; border-left: none; border-right: 3px solid var(--neon-pink); background: #222; }
        .bubble.sys { align-self: center; border: 1px solid #333; font-size: 0.8rem; color: #888; text-align: center; }
        
        .meta { font-size: 0.7rem; color: #666; display: flex; justify-content: space-between; margin-bottom: 4px; }
        .msg { font-size: 1.1rem; letter-spacing: 1px; font-weight: bold; font-family: 'Courier New', monospace; }

        /* INPUT AREA */
        #composer {
            background: #000; padding: 15px; border-top: 1px solid #333;
            display: flex; gap: 10px; align-items: center;
        }
        .input-wrap { flex: 1; position: relative; }
        input {
            width: 100%; background: #222; border: 1px solid #444; color: #fff;
            padding: 12px; border-radius: 20px; outline: none;
            font-size: 1rem; font-family: 'Courier New', monospace; text-transform: uppercase;
        }
        input:focus { border-color: var(--neon-green); }
        .char-count {
            position: absolute; right: 15px; top: 50%; transform: translateY(-50%);
            font-size: 0.7rem; color: #666;
        }
        .send-btn {
            background: var(--neon-blue); color: #000; border: none; border-radius: 50%;
            width: 45px; height: 45px; font-weight: 900; cursor: pointer;
            box-shadow: 0 0 15px var(--neon-blue);
        }
        .send-btn:disabled { background: #333; color: #555; box-shadow: none; }

        /* STATUS OVERLAY */
        #statusPill {
            position: fixed; top: 70px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.9); border: 1px solid var(--neon-green);
            padding: 8px 20px; border-radius: 20px; font-size: 0.8rem;
            color: var(--neon-green); opacity: 0; transition: 0.3s; pointer-events: none;
            display: flex; flex-direction: column; align-items: center;
            font-family: monospace;
        }
        #statusPill.active { opacity: 1; top: 80px; }
        .rx-buffer { font-size: 1.2rem; letter-spacing: 3px; margin-top: 5px; color: #fff; }

        /* VIZ */
        #viz { position: absolute; top: 0; left: 0; width: 100%; height: 4px; pointer-events: none; z-index: 101; }

        /* CALCULATOR DISGUISE */
        #calcDisguise {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #fff; color: #000; z-index: 9999;
            display: none; flex-direction: column; font-family: sans-serif;
        }
        .calc-screen { background: #222; color: #fff; height: 120px; width: 100%; font-size: 4rem; text-align: right; padding: 20px; box-sizing: border-box; }
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); height: 100%; }
        .calc-btn { border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; background: #eee; cursor: pointer;}
        .calc-btn.orange { background: #ff9500; color: #fff; }

        @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .pulse { animation: p 1s infinite; }
        @keyframes p { 0% { box-shadow: 0 0 0 0 rgba(0,255,100,0.4); } 100% { box-shadow: 0 0 0 10px rgba(0,0,0,0); } }
    </style>
</head>
<body>

    <!-- DISGUISE -->
    <div id="calcDisguise">
        <div class="calc-screen">0</div>
        <div class="calc-grid">
            <div class="calc-btn">AC</div><div class="calc-btn">+/-</div><div class="calc-btn">%</div><div class="calc-btn orange">Ã·</div>
            <div class="calc-btn">7</div><div class="calc-btn">8</div><div class="calc-btn">9</div><div class="calc-btn orange">Ã—</div>
            <div class="calc-btn">4</div><div class="calc-btn">5</div><div class="calc-btn">6</div><div class="calc-btn orange">-</div>
            <div class="calc-btn">1</div><div class="calc-btn">2</div><div class="calc-btn">3</div><div class="calc-btn orange">+</div>
            <div class="calc-btn" style="width:200%">0</div><div class="calc-btn">.</div><div class="calc-btn orange" onclick="togglePanic()">=</div>
        </div>
    </div>

    <canvas id="viz"></canvas>

    <header>
        <div class="brand">Chirp<span>Chain</span> <span style="font-size:0.5em; color:#666">v0.7</span></div>
        <div style="font-size:0.7rem; color:#888;" id="identity">...</div>
        <div class="panic-btn" onclick="togglePanic()">ðŸ§®</div>
    </header>

    <div id="statusPill">
        <span id="statusText">RECEIVING...</span>
        <div id="rxBuffer" class="rx-buffer"></div>
    </div>

    <div id="feed">
        <div style="text-align:center; color:#444; margin-top:50px; font-size:0.8rem;">
            <p><strong>SECRET NOTE PROTOCOL</strong></p>
            <p>Limit: 10 Characters</p>
            <p>Encoding: 6-bit + Checksum</p>
            <button onclick="startAudio()" style="margin-top:20px; padding:12px 24px; background:var(--neon-blue); color:#000; border:none; border-radius:20px; font-weight:bold;">ACTIVATE AUDIO</button>
        </div>
    </div>

    <div id="composer">
        <div class="input-wrap">
            <input type="text" id="msgInput" maxlength="10" placeholder="10 CHAR LIMIT" autocomplete="off" oninput="updateCount()">
            <div class="char-count" id="charCount">0/10</div>
        </div>
        <button class="send-btn" id="sendBtn" onclick="transmitMessage()">âž¤</button>
    </div>

<script>
/**
 * CHIRPCHAIN v0.7 - "PASS THE NOTE" PROTOCOL
 * 
 * ENCODING (6-bit):
 * A-Z (0-25), 0-9 (26-35), Space (36), . (37), ! (38), ? (39)
 * 
 * PACKET STRUCTURE:
 * [PILOT 400ms] [GAP 50ms] [LEN 4bit] [DATA N*6bit] [CHECKSUM 4bit]
 */

const CFG = {
    pilot: 18500, bit0: 19000, bit1: 19500,
    baud: 60, // 60ms per bit = ~16 bits/sec
    fft: 2048
};

const CHARSET = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 .!?"; // 40 chars maps to 6 bits (max 63)

// STATE
let ctx, analyser, mic, micAnalyser;
let myName = "", rxState = "IDLE", scannerInterval;
let ambientNoise = 0;

const ADJS = ["Silent","Neon","Hidden","Dark","Late","Fast"];
const NOUNS = ["Note","Whisper","Signal","Echo","Glitch","Vibe"];

// --- 1. SETUP ---
function genName() { return ADJS[Math.floor(Math.random()*ADJS.length)] + "_" + NOUNS[Math.floor(Math.random()*NOUNS.length)]; }
function togglePanic() { const d=document.getElementById('calcDisguise'); d.style.display = d.style.display==='flex'?'none':'flex'; }
function updateCount() { 
    const len = document.getElementById('msgInput').value.length;
    document.getElementById('charCount').innerText = `${len}/10`;
}

async function startAudio() {
    try {
        ctx = new (window.AudioContext || window.webkitAudioContext)();
        analyser = ctx.createAnalyser(); analyser.fftSize = CFG.fft; analyser.connect(ctx.destination);
        const s = await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:false,noiseSuppression:false}});
        mic = ctx.createMediaStreamSource(s); micAnalyser = ctx.createAnalyser(); micAnalyser.fftSize = CFG.fft; micAnalyser.smoothingTimeConstant=0.1; mic.connect(micAnalyser);
        
        myName = genName();
        document.getElementById('identity').innerText = myName;
        document.getElementById('feed').innerHTML = '<div class="bubble sys">Audio Channel Open. Listening...</div>';
        
        startScanner(); drawViz();
    } catch(e) { alert("Audio Error: " + e); }
}

// --- 2. ENCODING LOGIC ---
function encodeText(text) {
    let bits = "";
    let sum = 0;
    text = text.toUpperCase();
    
    // 1. Length Header (4 bits)
    bits += text.length.toString(2).padStart(4, '0');

    // 2. Data (6 bits per char)
    for(let i=0; i<text.length; i++) {
        const char = text[i];
        let idx = CHARSET.indexOf(char);
        if(idx === -1) idx = 36; // Default to space if unknown
        sum += idx;
        bits += idx.toString(2).padStart(6, '0');
    }

    // 3. Checksum (4 bits) - Simple Sum Modulo 16
    const checksum = sum % 16;
    bits += checksum.toString(2).padStart(4, '0');

    return bits;
}

function decodeBits(bits) {
    if(bits.length < 4) return null;
    
    // 1. Header
    const len = parseInt(bits.substr(0,4), 2);
    const expectedLen = 4 + (len * 6) + 4;
    
    if(bits.length < expectedLen) return null; // Wait for more data

    // 2. Payload
    let msg = "";
    let sum = 0;
    let ptr = 4;
    for(let i=0; i<len; i++) {
        const chunk = bits.substr(ptr, 6);
        const idx = parseInt(chunk, 2);
        msg += CHARSET[idx] || "?";
        sum += idx;
        ptr += 6;
    }

    // 3. Checksum Verify
    const rxChecksum = parseInt(bits.substr(ptr, 4), 2);
    const calcChecksum = sum % 16;

    if(rxChecksum !== calcChecksum) return { error: "CHECKSUM FAIL" };
    return { text: msg };
}

// --- 3. TRANSMISSION ---
function transmitMessage() {
    if(!ctx) return;
    const input = document.getElementById('msgInput');
    const text = input.value.toUpperCase().substr(0,10);
    if(!text) return;

    input.value = ""; updateCount();
    addBubble(myName, text, "mine");
    
    const bitstream = encodeText(text);
    const btn = document.getElementById('sendBtn');
    btn.disabled = true;
    
    // Play Audio
    const t = ctx.currentTime;
    playTone(CFG.pilot, t, 0.4); // Pilot
    let tStart = t + 0.45;

    for(let i=0; i<bitstream.length; i++) {
        const freq = bitstream[i] === '1' ? CFG.bit1 : CFG.bit0;
        playTone(freq, tStart, CFG.baud/1000);
        tStart += (CFG.baud/1000);
    }

    setTimeout(() => { btn.disabled = false; }, (tStart - t)*1000);
}

// --- 4. RECEPTION (STATE MACHINE) ---
function startScanner() {
    let noiseArr = [];
    // Calibrate
    const cal = setInterval(()=>{ noiseArr.push(getEnergy(CFG.pilot)); if(noiseArr.length>20){ clearInterval(cal); ambientNoise=Math.max(5, (noiseArr.reduce((a,b)=>a+b)/20)*1.3); } }, 50);

    scannerInterval = setInterval(() => {
        if(rxState === 'IDLE') {
            if(getEnergy(CFG.pilot) > ambientNoise * 1.5) {
                rxState = 'SYNC';
                setStatus("INCOMING...", "", true);
            }
        } else if (rxState === 'SYNC') {
            // Wait for pilot to drop
            if(getEnergy(CFG.pilot) < ambientNoise * 1.2) {
                rxState = 'READING';
                setTimeout(readBits, CFG.baud/2); // Align center
            }
        }
    }, 20);
}

function readBits() {
    let rawBits = "";
    let bitTimer = setInterval(() => {
        const e0 = getEnergy(CFG.bit0);
        const e1 = getEnergy(CFG.bit1);
        
        // Simple Voting
        if(e1 > e0 && e1 > ambientNoise) rawBits += "1";
        else if(e0 > e1 && e0 > ambientNoise) rawBits += "0";
        else {
            // Silence detected - End of packet
            clearInterval(bitTimer);
            finalizePacket(rawBits);
            return;
        }

        // Live Decoding UI
        if(rawBits.length > 4 && (rawBits.length-4)%6 === 0) {
            // Attempt partial decode for cool UI effect
            const partial = decodeBits(rawBits + "0000"); // Padding
            if(partial && partial.text) setStatus("DECODING", partial.text, true);
        }

        // Failsafe timeout
        if(rawBits.length > 80) { clearInterval(bitTimer); rxState="IDLE"; setStatus("",""); }

    }, CFG.baud);
}

function finalizePacket(bits) {
    rxState = "IDLE";
    setStatus("FINISHING...", "");
    
    setTimeout(() => {
        const res = decodeBits(bits);
        if(res && res.text) {
            addBubble("Peer", res.text);
            setStatus("RECEIVED", "", false);
        } else if (res && res.error) {
            setStatus("CORRUPTED DATA", "", false);
            setTimeout(()=>setStatus("","",false), 1000);
        } else {
            setStatus("","",false);
        }
    }, 200);
}


// --- UTILS ---
function addBubble(auth, txt, type="") {
    const d = document.createElement('div');
    d.className = `bubble ${type}`;
    d.innerHTML = `<div class="meta"><span>${auth}</span><span>${new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span></div><div class="msg">${txt}</div>`;
    const f = document.getElementById('feed');
    f.appendChild(d); f.scrollTop = f.scrollHeight;
}

function setStatus(txt, buffer, active) {
    const p = document.getElementById('statusPill');
    document.getElementById('statusText').innerText = txt;
    document.getElementById('rxBuffer').innerText = buffer;
    if(active) p.classList.add('active'); else p.classList.remove('active');
}

function playTone(f, t, d) {
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.frequency.value=f; g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(0.5,t+0.01); g.gain.linearRampToValueAtTime(0,t+d);
    o.connect(g); g.connect(ctx.destination); o.start(t); o.stop(t+d);
}

function getEnergy(f) {
    const n = ctx.sampleRate/2;
    const b = Math.round(f / (n/micAnalyser.frequencyBinCount));
    const d = new Uint8Array(micAnalyser.frequencyBinCount);
    micAnalyser.getByteFrequencyData(d);
    return d[b];
}

function drawViz() {
    const c=document.getElementById('viz'), cc=c.getContext('2d'); c.width=window.innerWidth;
    const d=new Uint8Array(micAnalyser.frequencyBinCount);
    function l() { requestAnimationFrame(l); micAnalyser.getByteFrequencyData(d); cc.clearRect(0,0,c.width,c.height);
        const s=Math.floor(18000/(ctx.sampleRate/2/CFG.fft)), sl=d.slice(s), w=c.width/sl.length;
        cc.fillStyle='#ff00ff'; for(let i=0;i<sl.length;i++) if(sl[i]>10) cc.fillRect(i*w,0,w,4);
    } l();
}
</script>
</body>
</html>