<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WhisperChain</title>
    <style>
        :root { 
            --bg: #ffffff; 
            --text: #000000; 
            --border: #e0e0e0; 
            --accent: #333333;
        }
        body { 
            background: var(--bg); color: var(--text); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; padding: 0; 
            height: 100vh; display: flex; flex-direction: column;
        }

        /* HEADER */
        header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .brand { font-weight: 700; font-size: 1rem; letter-spacing: -0.5px; }
        .panic-btn { cursor: pointer; font-size: 1.2rem; color: #999; }
        .panic-btn:hover { color: #000; }

        /* INPUT AREA (TOP) */
        #composer {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex; gap: 10px; align-items: center;
        }
        input {
            flex: 1; border: none; background: #f5f5f5; color: #000;
            padding: 12px 15px; border-radius: 6px; outline: none;
            font-family: monospace; text-transform: uppercase; font-size: 1rem;
        }
        input::placeholder { color: #ccc; }
        input:focus { background: #eee; }
        
        .send-btn {
            background: #000; color: #fff; border: none; border-radius: 6px;
            padding: 12px 20px; font-weight: 600; cursor: pointer;
            font-size: 0.9rem;
        }
        .send-btn:disabled { background: #ccc; cursor: default; }

        /* FEED */
        #feed {
            flex: 1; overflow-y: auto; padding: 20px;
            display: flex; flex-direction: column; gap: 8px;
        }
        
        .msg-row {
            padding: 8px 0;
            border-bottom: 1px solid #f9f9f9;
            display: flex; gap: 10px; align-items: baseline;
            animation: fadeIn 0.2s ease;
        }
        .msg-time { font-size: 0.7rem; color: #999; font-family: monospace; min-width: 40px; }
        .msg-text { font-size: 0.95rem; font-weight: 500; letter-spacing: 0.5px; }
        .msg-row.sys { justify-content: center; color: #999; font-size: 0.8rem; font-style: italic; border:none;}

        /* STATUS & VIZ */
        #status {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #000; color: #fff; padding: 6px 16px; border-radius: 20px;
            font-size: 0.75rem; opacity: 0; transition: 0.2s; pointer-events: none;
            display: flex; gap: 8px; align-items: center;
        }
        #status.active { opacity: 1; bottom: 30px; }
        
        #viz { position: fixed; top: 0; left: 0; width: 100%; height: 2px; z-index: 99; pointer-events: none; }

        /* INIT BUTTON */
        #initOverlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; display: flex; align-items: center; justify-content: center;
            z-index: 50;
        }
        .activate-btn {
            background: #fff; border: 1px solid #000; padding: 15px 30px;
            font-weight: 600; cursor: pointer; transition: 0.2s;
        }
        .activate-btn:hover { background: #000; color: #fff; }

        /* CALCULATOR DISGUISE (Light Theme) */
        #calcDisguise {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #fff; color: #000; z-index: 9999;
            display: none; flex-direction: column; font-family: sans-serif;
        }
        .calc-screen { background: #f0f0f0; color: #000; height: 150px; width: 100%; font-size: 4rem; text-align: right; padding: 30px; box-sizing: border-box; font-weight: 300; }
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); height: 100%; }
        .calc-btn { border: 1px solid #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; background: #fff; cursor: pointer; color: #333; }
        .calc-btn.orange { background: #ff9f0a; color: #fff; border:none; }
        .calc-btn.grey { background: #e5e5e5; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <!-- DISGUISE -->
    <div id="calcDisguise">
        <div class="calc-screen">0</div>
        <div class="calc-grid">
            <div class="calc-btn grey">AC</div><div class="calc-btn grey">+/-</div><div class="calc-btn grey">%</div><div class="calc-btn orange">รท</div>
            <div class="calc-btn">7</div><div class="calc-btn">8</div><div class="calc-btn">9</div><div class="calc-btn orange">ร</div>
            <div class="calc-btn">4</div><div class="calc-btn">5</div><div class="calc-btn">6</div><div class="calc-btn orange">-</div>
            <div class="calc-btn">1</div><div class="calc-btn">2</div><div class="calc-btn">3</div><div class="calc-btn orange">+</div>
            <div class="calc-btn" style="width:200%">0</div><div class="calc-btn">.</div><div class="calc-btn orange" onclick="togglePanic()">=</div>
        </div>
    </div>

    <canvas id="viz"></canvas>

    <header>
        <div class="brand">WhisperChain</div>
        <div class="panic-btn" onclick="togglePanic()">รท</div>
    </header>

    <div id="composer">
        <input type="text" id="msgInput" maxlength="10" placeholder="10 CHAR LIMIT..." autocomplete="off">
        <button class="send-btn" id="sendBtn" onclick="transmit()">Send</button>
    </div>

    <div id="feed">
        <!-- Messages appear here -->
    </div>

    <div id="status">
        <span id="statusTxt">Receiving...</span>
        <span id="statusBuffer" style="font-family:monospace; color:#ccc"></span>
    </div>

    <div id="initOverlay">
        <button class="activate-btn" onclick="startSystem()">Connect Audio</button>
    </div>

<script>
/**
 * WHISPERCHAIN
 * 6-bit Binary Protocol over Air-Gapped Audio
 */

const CFG = {
    pilot: 18500, bit0: 19000, bit1: 19500,
    baud: 60, fft: 2048
};

const CHARSET = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 .!?"; 

let ctx, analyser, mic, micAnalyser;
let rxState = "IDLE", scannerInterval, ambientNoise = 0;

function togglePanic() { 
    const d = document.getElementById('calcDisguise'); 
    d.style.display = d.style.display==='flex'?'none':'flex'; 
    document.title = d.style.display==='flex'?'Calculator':'WhisperChain';
}

async function startSystem() {
    try {
        ctx = new (window.AudioContext || window.webkitAudioContext)();
        analyser = ctx.createAnalyser(); analyser.fftSize = CFG.fft; analyser.connect(ctx.destination);
        const s = await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:false,noiseSuppression:false}});
        mic = ctx.createMediaStreamSource(s); micAnalyser = ctx.createAnalyser(); micAnalyser.fftSize = CFG.fft; micAnalyser.smoothingTimeConstant=0.1; mic.connect(micAnalyser);
        
        document.getElementById('initOverlay').style.display = 'none';
        addMsg("System", "Channel Open.");
        startScanner(); drawViz();
    } catch(e) { alert("Microphone access required."); }
}

// --- ENCODING ---
function encode(text) {
    let bits = "", sum = 0; text = text.toUpperCase();
    bits += text.length.toString(2).padStart(4, '0'); // Header
    for(let i=0; i<text.length; i++) {
        let idx = CHARSET.indexOf(text[i]); if(idx === -1) idx = 36;
        sum += idx; bits += idx.toString(2).padStart(6, '0');
    }
    bits += (sum % 16).toString(2).padStart(4, '0'); // Checksum
    return bits;
}

function decode(bits) {
    if(bits.length < 4) return null;
    const len = parseInt(bits.substr(0,4), 2);
    if(bits.length < 4 + (len*6) + 4) return null;

    let msg = "", sum = 0, ptr = 4;
    for(let i=0; i<len; i++) {
        const idx = parseInt(bits.substr(ptr, 6), 2);
        msg += CHARSET[idx] || "?"; sum += idx; ptr += 6;
    }
    const cSum = parseInt(bits.substr(ptr, 4), 2);
    if(cSum !== sum % 16) return { err: true };
    return { text: msg };
}

// --- TX ---
function transmit() {
    if(!ctx) return;
    const inp = document.getElementById('msgInput');
    const txt = inp.value.toUpperCase().substr(0,10);
    if(!txt) return;

    inp.value = "";
    addMsg("Me", txt);
    
    const bits = encode(txt);
    const btn = document.getElementById('sendBtn');
    btn.disabled = true; btn.innerText = "...";

    const t = ctx.currentTime;
    playTone(CFG.pilot, t, 0.4);
    let tStart = t + 0.45;

    for(let i=0; i<bits.length; i++) {
        playTone(bits[i]==='1'?CFG.bit1:CFG.bit0, tStart, CFG.baud/1000);
        tStart += (CFG.baud/1000);
    }

    setTimeout(() => { btn.disabled = false; btn.innerText = "Send"; }, (tStart - t)*1000);
}

// --- RX ---
function startScanner() {
    let nArr = [];
    const cal = setInterval(()=>{ nArr.push(getE(CFG.pilot)); if(nArr.length>20){ clearInterval(cal); ambientNoise=Math.max(5, (nArr.reduce((a,b)=>a+b)/20)*1.3); } }, 50);

    scannerInterval = setInterval(() => {
        if(rxState === 'IDLE') {
            if(getE(CFG.pilot) > ambientNoise * 1.5) { rxState = 'SYNC'; setStatus("Signal detected...", true); }
        } else if (rxState === 'SYNC') {
            if(getE(CFG.pilot) < ambientNoise * 1.2) { rxState = 'READING'; setTimeout(readBits, CFG.baud/2); }
        }
    }, 20);
}

function readBits() {
    let bits = "";
    let tmr = setInterval(() => {
        const e0 = getE(CFG.bit0), e1 = getE(CFG.bit1);
        if(e1>e0 && e1>ambientNoise) bits+="1"; 
        else if(e0>e1 && e0>ambientNoise) bits+="0"; 
        else { clearInterval(tmr); finish(bits); return; }
        
        // Live Decode Preview
        if(bits.length > 4 && (bits.length-4)%6===0) {
           const p = decode(bits+"0000");
           if(p && p.text) document.getElementById('statusBuffer').innerText = p.text;
        }
        if(bits.length > 80) { clearInterval(tmr); rxState="IDLE"; setStatus("", false); }
    }, CFG.baud);
}

function finish(bits) {
    rxState = "IDLE";
    setStatus("", false);
    const res = decode(bits);
    if(res && res.text) addMsg("Peer", res.text);
}

// --- UTILS ---
function addMsg( user, text) {
    const d = document.createElement('div');
    d.className = user==="System" ? "msg-row sys" : "msg-row";
    const time = new Date().toLocaleTimeString([], {hour12:false, hour:'2-digit', minute:'2-digit'});
    if(user==="System") d.innerHTML = text;
    else d.innerHTML = `<div class="msg-time">${time}</div><div class="msg-text">${text}</div>`;
    const f = document.getElementById('feed');
    f.prepend(d);
}

function setStatus(txt, active) {
    const s = document.getElementById('status');
    document.getElementById('statusTxt').innerText = txt;
    if(!active) document.getElementById('statusBuffer').innerText = "";
    if(active) s.classList.add('active'); else s.classList.remove('active');
}

function playTone(f, t, d) {
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.frequency.value=f; g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(0.5,t+0.01); g.gain.linearRampToValueAtTime(0,t+d);
    o.connect(g); g.connect(ctx.destination); o.start(t); o.stop(t+d);
}

function getE(f) {
    const n = ctx.sampleRate/2;
    const b = Math.round(f / (n/micAnalyser.frequencyBinCount));
    const d = new Uint8Array(micAnalyser.frequencyBinCount);
    micAnalyser.getByteFrequencyData(d);
    return d[b];
}

function drawViz() {
    const c=document.getElementById('viz'), cc=c.getContext('2d'); c.width=window.innerWidth;
    const d=new Uint8Array(micAnalyser.frequencyBinCount);
    function l() { requestAnimationFrame(l); micAnalyser.getByteFrequencyData(d); cc.clearRect(0,0,c.width,c.height);
        const s=Math.floor(18000/(ctx.sampleRate/2/CFG.fft)), sl=d.slice(s), w=c.width/sl.length;
        cc.fillStyle='#000'; for(let i=0;i<sl.length;i++) if(sl[i]>10) cc.fillRect(i*w,0,w,2);
    } l();
}
</script>
</body>
</html>